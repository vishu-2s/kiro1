"""
Unit tests for Vulnerability Analysis Agent.

Tests the core functionality of the VulnerabilityAnalysisAgent including:
- OSV API integration
- CVSS score calculation
- Vulnerability impact assessment
- Caching functionality
"""

import pytest
from unittest.mock import Mock, patch, MagicMock
from agents.vulnerability_agent import VulnerabilityAnalysisAgent
from agents.types import SharedContext, Finding
from tools.api_integration import APIResponse, APIError, APIErrorType


class TestVulnerabilityAnalysisAgent:
    """Test suite for VulnerabilityAnalysisAgent."""
    
    @pytest.fixture
    def agent(self):
        """Create a VulnerabilityAnalysisAgent instance for testing."""
        return VulnerabilityAnalysisAgent()
    
    @pytest.fixture
    def mock_context(self):
        """Create a mock SharedContext for testing."""
        findings = [
            Finding(
                package_name="test-package",
                package_version="1.0.0",
                finding_type="vulnerability",
                severity="high",
                description="Test vulnerability",
                detection_method="rule_based"
            )
        ]
        
        return SharedContext(
            initial_findings=findings,
            dependency_graph={"packages": []},
            packages=["test-package"],
            ecosystem="npm"
        )
    
    def test_agent_initialization(self, agent):
        """Test that agent initializes correctly."""
        assert agent.name == "VulnerabilityAnalysisAgent"
        assert agent.osv_client is not None
        assert agent.cache_manager is not None
        assert len(agent.tools) == 3
    
    def test_calculate_cvss_with_score(self, agent):
        """Test CVSS calculation with explicit score."""
        vuln = {
            "severity": [
                {
                    "type": "CVSS_V3",
                    "score": 7.5
                }
            ]
        }
        
        cvss_score, severity = agent.calculate_cvss(vuln)
        
        assert cvss_score == 7.5
        assert severity == "high"
    
    def test_calculate_cvss_from_severity_string(self, agent):
        """Test CVSS calculation from severity string."""
        vuln = {
            "database_specific": {
                "severity": "CRITICAL"
            }
        }
        
        cvss_score, severity = agent.calculate_cvss(vuln)
        
        assert cvss_score == 9.5
        assert severity == "critical"
    
    def test_calculate_cvss_unknown(self, agent):
        """Test CVSS calculation with no severity data."""
        vuln = {}
        
        cvss_score, severity = agent.calculate_cvss(vuln)
        
        assert cvss_score == 0.0
        assert severity == "unknown"
    
    def test_assess_combined_impact_no_vulnerabilities(self, agent):
        """Test combined impact assessment with no vulnerabilities."""
        result = agent._assess_combined_impact([])
        
        assert result["overall_severity"] == "none"
        assert result["max_cvss_score"] == 0.0
        assert result["critical_count"] == 0
        assert result["risk_level"] == "low"
    
    def test_assess_combined_impact_critical(self, agent):
        """Test combined impact assessment with critical vulnerabilities."""
        vulnerabilities = [
            {"severity": "critical", "cvss_score": 9.5},
            {"severity": "high", "cvss_score": 7.5}
        ]
        
        result = agent._assess_combined_impact(vulnerabilities)
        
        assert result["overall_severity"] == "critical"
        assert result["max_cvss_score"] == 9.5
        assert result["critical_count"] == 1
        assert result["high_count"] == 1
        assert result["risk_level"] == "critical"
    
    def test_assess_combined_impact_multiple_high(self, agent):
        """Test that multiple high severity vulnerabilities escalate risk."""
        vulnerabilities = [
            {"severity": "high", "cvss_score": 7.5},
            {"severity": "high", "cvss_score": 7.0},
            {"severity": "high", "cvss_score": 8.0}
        ]
        
        result = agent._assess_combined_impact(vulnerabilities)
        
        assert result["overall_severity"] == "high"
        assert result["high_count"] == 3
        assert result["risk_level"] == "critical"  # Escalated due to count
    
    def test_extract_affected_versions(self, agent):
        """Test extraction of affected versions from vulnerability data."""
        vuln = {
            "affected": [
                {
                    "ranges": [
                        {
                            "events": [
                                {"introduced": "1.0.0"},
                                {"fixed": "2.0.0"}
                            ]
                        }
                    ],
                    "versions": ["1.5.0", "1.6.0"]
                }
            ]
        }
        
        affected = agent._extract_affected_versions(vuln)
        
        assert ">=1.0.0" in affected
        assert "<2.0.0" in affected
        assert "1.5.0" in affected
        assert "1.6.0" in affected
    
    def test_extract_fixed_versions(self, agent):
        """Test extraction of fixed versions from vulnerability data."""
        vuln = {
            "affected": [
                {
                    "ranges": [
                        {
                            "events": [
                                {"introduced": "1.0.0"},
                                {"fixed": "2.0.0"}
                            ]
                        }
                    ]
                }
            ]
        }
        
        fixed = agent._extract_fixed_versions(vuln)
        
        assert "2.0.0" in fixed
    
    def test_calculate_package_confidence_no_vulnerabilities(self, agent):
        """Test confidence calculation with no vulnerabilities."""
        confidence = agent._calculate_package_confidence([], "test-package")
        
        assert confidence == 0.85  # Reduced confidence for no vulnerabilities
    
    def test_calculate_package_confidence_with_detailed_vulns(self, agent):
        """Test confidence calculation with detailed vulnerabilities."""
        vulnerabilities = [
            {"severity": "high", "cvss_score": 7.5},
            {"severity": "medium", "cvss_score": 5.0}
        ]
        
        confidence = agent._calculate_package_confidence(vulnerabilities, "test-package")
        
        assert confidence == 1.0  # Maximum confidence with detailed data
    
    def test_calculate_package_confidence_with_unknown_severity(self, agent):
        """Test confidence calculation with unknown severity."""
        vulnerabilities = [
            {"severity": "unknown", "cvss_score": 0.0},
            {"severity": "high", "cvss_score": 7.5}
        ]
        
        confidence = agent._calculate_package_confidence(vulnerabilities, "test-package")
        
        assert confidence < 0.95  # Reduced confidence due to unknown severity
    
    def test_generate_reasoning_no_vulnerabilities(self, agent):
        """Test reasoning generation with no vulnerabilities."""
        reasoning = agent._generate_reasoning([], {})
        
        assert "No known vulnerabilities" in reasoning
    
    def test_generate_reasoning_with_critical(self, agent):
        """Test reasoning generation with critical vulnerabilities."""
        vulnerabilities = [
            {"severity": "critical", "cvss_score": 9.5}
        ]
        combined_impact = {
            "overall_severity": "critical",
            "critical_count": 1,
            "high_count": 0,
            "risk_level": "critical"
        }
        
        reasoning = agent._generate_reasoning(vulnerabilities, combined_impact)
        
        assert "1 known vulnerability" in reasoning
        assert "1 critical severity" in reasoning
        assert "immediate attention" in reasoning
    
    def test_generate_cache_key(self, agent):
        """Test cache key generation."""
        key = agent._generate_cache_key("test-package", "npm", "1.0.0")
        
        assert key == "vuln:npm:test-package:1.0.0"
    
    def test_generate_cache_key_no_version(self, agent):
        """Test cache key generation without version."""
        key = agent._generate_cache_key("test-package", "npm", None)
        
        assert key == "vuln:npm:test-package"
    
    @patch('agents.vulnerability_agent.OSVAPIClient')
    def test_query_osv_api_success(self, mock_osv_client_class, agent):
        """Test successful OSV API query."""
        # Mock the API response
        mock_response = Mock(spec=APIResponse)
        mock_response.is_success.return_value = True
        mock_response.get_data.return_value = {
            "vulns": [
                {
                    "id": "GHSA-test-1234",
                    "summary": "Test vulnerability",
                    "severity": [{"type": "CVSS_V3", "score": 7.5}]
                }
            ]
        }
        
        agent.osv_client.query_vulnerabilities = Mock(return_value=mock_response)
        
        # Query API
        vulnerabilities = agent.query_osv_api("test-package", "npm", "1.0.0")
        
        assert len(vulnerabilities) == 1
        assert vulnerabilities[0]["id"] == "GHSA-test-1234"
    
    @patch('agents.vulnerability_agent.OSVAPIClient')
    def test_query_osv_api_failure(self, mock_osv_client_class, agent):
        """Test OSV API query failure."""
        # Mock the API response
        mock_response = Mock(spec=APIResponse)
        mock_response.is_success.return_value = False
        mock_response.error = APIError(
            error_type=APIErrorType.NETWORK,
            message="Network error"
        )
        
        agent.osv_client.query_vulnerabilities = Mock(return_value=mock_response)
        
        # Query API
        vulnerabilities = agent.query_osv_api("test-package", "npm", "1.0.0")
        
        assert len(vulnerabilities) == 0
    
    @patch('agents.vulnerability_agent.get_cache_manager')
    def test_get_cached_vuln(self, mock_cache_manager, agent):
        """Test retrieving cached vulnerability data."""
        # Mock cache manager
        mock_cache = Mock()
        mock_cache.get_reputation.return_value = {
            "package_name": "test-package",
            "vulnerabilities": []
        }
        agent.cache_manager = mock_cache
        
        # Get cached data
        result = agent.get_cached_vuln("test-package", "npm", "1.0.0")
        
        assert result is not None
        assert result["package_name"] == "test-package"
    
    def test_analyze_invalid_context(self, agent):
        """Test analyze with invalid context."""
        invalid_context = Mock()
        invalid_context.packages = []
        
        result = agent.analyze(invalid_context)
        
        assert "error" in result
        assert result["success"] == False
    
    @patch('agents.vulnerability_agent.OSVAPIClient')
    def test_analyze_with_timeout(self, mock_osv_client_class, agent, mock_context):
        """Test analyze with timeout."""
        # Mock slow API response
        def slow_query(*args, **kwargs):
            import time
            time.sleep(2)
            return []
        
        agent.query_osv_api = slow_query
        
        # Analyze with short timeout
        result = agent.analyze(mock_context, timeout=1)
        
        # Should timeout and return partial results
        assert "packages" in result
        assert result["total_packages_analyzed"] >= 0


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
