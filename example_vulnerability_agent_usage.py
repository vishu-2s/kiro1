"""
Example usage of the Vulnerability Analysis Agent.

This script demonstrates how to use the VulnerabilityAnalysisAgent to analyze
packages for vulnerabilities using the OSV API.
"""

from agents.vulnerability_agent import VulnerabilityAnalysisAgent
from agents.types import SharedContext, Finding


def example_basic_usage():
    """Basic example of using the Vulnerability Analysis Agent."""
    print("=" * 80)
    print("Example 1: Basic Vulnerability Analysis")
    print("=" * 80)
    
    # Create the agent
    agent = VulnerabilityAnalysisAgent()
    
    # Create mock findings (normally these come from rule-based detection)
    findings = [
        Finding(
            package_name="express",
            package_version="4.17.0",
            finding_type="dependency",
            severity="unknown",
            description="Express web framework",
            detection_method="rule_based"
        ),
        Finding(
            package_name="lodash",
            package_version="4.17.15",
            finding_type="dependency",
            severity="unknown",
            description="Lodash utility library",
            detection_method="rule_based"
        )
    ]
    
    # Create shared context
    context = SharedContext(
        initial_findings=findings,
        dependency_graph={"packages": []},
        packages=["express", "lodash"],
        ecosystem="npm",
        input_mode="local",
        project_path="/path/to/project"
    )
    
    # Analyze vulnerabilities
    print("\nAnalyzing packages for vulnerabilities...")
    result = agent.analyze(context, timeout=30)
    
    # Display results
    print(f"\nAnalysis complete!")
    print(f"Total packages analyzed: {result['total_packages_analyzed']}")
    print(f"Total vulnerabilities found: {result['total_vulnerabilities_found']}")
    print(f"Overall confidence: {result['confidence']:.2f}")
    print(f"Duration: {result['duration_seconds']:.2f}s")
    
    # Display package-level results
    for package_result in result['packages']:
        print(f"\n--- Package: {package_result['package_name']} ---")
        print(f"Version: {package_result['package_version']}")
        print(f"Vulnerabilities: {package_result['vulnerability_count']}")
        print(f"Confidence: {package_result['confidence']:.2f}")
        print(f"Reasoning: {package_result['reasoning']}")
        
        if package_result['vulnerabilities']:
            print("\nVulnerabilities:")
            for vuln in package_result['vulnerabilities']:
                print(f"  - {vuln['id']}: {vuln['summary']}")
                print(f"    Severity: {vuln['severity']} (CVSS: {vuln['cvss_score']})")
                print(f"    Affected versions: {', '.join(vuln['affected_versions'][:3])}")
                if vuln['fixed_versions']:
                    print(f"    Fixed in: {', '.join(vuln['fixed_versions'][:3])}")


def example_direct_osv_query():
    """Example of directly querying the OSV API."""
    print("\n" + "=" * 80)
    print("Example 2: Direct OSV API Query")
    print("=" * 80)
    
    # Create the agent
    agent = VulnerabilityAnalysisAgent()
    
    # Query OSV API directly
    print("\nQuerying OSV API for 'lodash' vulnerabilities...")
    vulnerabilities = agent.query_osv_api(
        package="lodash",
        ecosystem="npm",
        version="4.17.15"
    )
    
    print(f"Found {len(vulnerabilities)} vulnerabilities")
    
    for vuln in vulnerabilities[:3]:  # Show first 3
        print(f"\n- {vuln.get('id', 'UNKNOWN')}")
        print(f"  Summary: {vuln.get('summary', 'No summary')}")
        
        # Calculate CVSS
        cvss_score, severity = agent.calculate_cvss(vuln)
        print(f"  CVSS Score: {cvss_score} ({severity})")


def example_cvss_calculation():
    """Example of CVSS score calculation."""
    print("\n" + "=" * 80)
    print("Example 3: CVSS Score Calculation")
    print("=" * 80)
    
    # Create the agent
    agent = VulnerabilityAnalysisAgent()
    
    # Example vulnerability data
    test_vulnerabilities = [
        {
            "name": "Critical vulnerability",
            "data": {
                "severity": [{"type": "CVSS_V3", "score": 9.8}]
            }
        },
        {
            "name": "High severity vulnerability",
            "data": {
                "database_specific": {"severity": "HIGH"}
            }
        },
        {
            "name": "Medium severity vulnerability",
            "data": {
                "database_specific": {"severity": "MEDIUM"}
            }
        }
    ]
    
    print("\nCalculating CVSS scores:")
    for vuln_info in test_vulnerabilities:
        cvss_score, severity = agent.calculate_cvss(vuln_info["data"])
        print(f"- {vuln_info['name']}: {cvss_score} ({severity})")


def example_caching():
    """Example demonstrating caching functionality."""
    print("\n" + "=" * 80)
    print("Example 4: Caching Demonstration")
    print("=" * 80)
    
    # Create the agent
    agent = VulnerabilityAnalysisAgent()
    
    # Clear cache for clean demo
    agent.cache_manager.clear_all()
    
    # Create context
    findings = [
        Finding(
            package_name="express",
            package_version="4.17.0",
            finding_type="dependency",
            severity="unknown",
            description="Express web framework",
            detection_method="rule_based"
        )
    ]
    
    context = SharedContext(
        initial_findings=findings,
        dependency_graph={"packages": []},
        packages=["express"],
        ecosystem="npm"
    )
    
    # First analysis (will query API)
    print("\nFirst analysis (querying API)...")
    import time
    start = time.time()
    result1 = agent.analyze(context)
    duration1 = time.time() - start
    print(f"Duration: {duration1:.2f}s")
    
    # Second analysis (should use cache)
    print("\nSecond analysis (using cache)...")
    start = time.time()
    result2 = agent.analyze(context)
    duration2 = time.time() - start
    print(f"Duration: {duration2:.2f}s")
    
    print(f"\nSpeedup from caching: {duration1/duration2:.2f}x")
    
    # Show cache statistics
    stats = agent.cache_manager.get_statistics()
    print(f"\nCache statistics:")
    print(f"  Total entries: {stats.get('total_entries', 0)}")
    print(f"  Total hits: {stats.get('total_hits', 0)}")
    print(f"  Size: {stats.get('size_mb', 0):.2f} MB")


def main():
    """Run all examples."""
    print("\n" + "=" * 80)
    print("Vulnerability Analysis Agent - Usage Examples")
    print("=" * 80)
    
    try:
        # Run examples
        example_basic_usage()
        example_direct_osv_query()
        example_cvss_calculation()
        example_caching()
        
        print("\n" + "=" * 80)
        print("All examples completed successfully!")
        print("=" * 80)
        
    except Exception as e:
        print(f"\nError running examples: {str(e)}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
