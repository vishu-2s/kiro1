<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spyder - AI-Powered Supply Chain Security Scanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rubik+Glitch&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/halloween-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif;
            background: #FAFAFA;
            min-height: 100vh;
            color: #1A1A1A;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #FFFFFF;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .header {
            background: #1A1A1A;
            color: #FFFFFF;
            padding: 20px 40px;
            border-bottom: 1px solid #E5E5E5;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(220, 38, 38, 0.03) 50px, rgba(220, 38, 38, 0.03) 51px),
                repeating-linear-gradient(60deg, transparent, transparent 50px, rgba(34, 197, 94, 0.03) 50px, rgba(34, 197, 94, 0.03) 51px),
                repeating-linear-gradient(120deg, transparent, transparent 50px, rgba(220, 38, 38, 0.02) 50px, rgba(220, 38, 38, 0.02) 51px),
                repeating-linear-gradient(-60deg, transparent, transparent 50px, rgba(34, 197, 94, 0.02) 50px, rgba(34, 197, 94, 0.02) 51px);
            background-size: 100% 100%;
            opacity: 0.8;
            pointer-events: none;
            animation: webPulse 4s ease-in-out infinite;
        }

        .header::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            width: 600px;
            height: 600px;
            background: 
                radial-gradient(circle, transparent 30%, rgba(220, 38, 38, 0.05) 30%, rgba(220, 38, 38, 0.05) 31%, transparent 31%),
                radial-gradient(circle, transparent 45%, rgba(34, 197, 94, 0.04) 45%, rgba(34, 197, 94, 0.04) 46%, transparent 46%),
                radial-gradient(circle, transparent 60%, rgba(220, 38, 38, 0.03) 60%, rgba(220, 38, 38, 0.03) 61%, transparent 61%),
                radial-gradient(circle, transparent 75%, rgba(34, 197, 94, 0.02) 75%, rgba(34, 197, 94, 0.02) 76%, transparent 76%);
            transform: translate(-50%, -50%);
            animation: shockwave 6s ease-out infinite;
            pointer-events: none;
            opacity: 0.6;
        }

        @keyframes webPulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.02); }
        }

        @keyframes shockwave {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            20% { opacity: 0.6; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 16px;
            max-width: 1320px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header-logo {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInScale 0.8s ease-out;
        }

        .header-logo img {
            height: 250%;
            width: auto;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .header-logo img:hover {
            transform: scale(1.05) rotate(2deg);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .header-text { flex: 1; }

        .header h1 {
            font-size: 42px;
            font-weight: 400;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
            font-family: 'Rubik Glitch', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            animation: slideInRight 0.6s ease-out;
            background: linear-gradient(135deg, #FFFFFF 0%, #E5E5E5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .header p {
            font-size: 14px;
            color: #A0A0A0;
            font-weight: 400;
            letter-spacing: 0.01em;
            animation: slideInRight 0.6s ease-out 0.2s both;
        }

        .header-badges {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-badge {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #FFFFFF;
            white-space: nowrap;
            animation: fadeInUp 0.6s ease-out backwards;
            transition: all 0.3s ease;
        }

        .header-badge:nth-child(1) { animation-delay: 0.3s; }
        .header-badge:nth-child(2) { animation-delay: 0.4s; }
        .header-badge:nth-child(3) { animation-delay: 0.5s; }

        .header-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        .header-badge.status {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.3);
            color: #4ADE80;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }

        .tabs {
            display: flex;
            background: #FFFFFF;
            border-bottom: 1px solid #E5E5E5;
            padding: 0 40px;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #666666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            position: relative;
            overflow: hidden;
        }

        .tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: #DC2626;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-50%);
        }

        .tab:hover { color: #1A1A1A; background: #F5F5F5; }
        .tab:hover::before { width: 80%; }
        .tab.active { color: #1A1A1A; border-bottom-color: #DC2626; background: transparent; }
        .tab.active::before { width: 100%; }

        .tab-content {
            display: none;
            padding: 40px;
            max-width: 1320px;
            margin: 0 auto;
        }

        .tab-content.active { display: block; }

        .control-panel {
            background: #FAFAFA;
            padding: 32px;
            border: 1px solid #E5E5E5;
            border-radius: 4px;
            margin-bottom: 32px;
        }

        .form-group { margin-bottom: 24px; }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 13px;
            color: #1A1A1A;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .mode-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #D4D4D4;
            background: #FFFFFF;
            color: #1A1A1A;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .mode-btn:hover { background: #1A1A1A; color: #FFFFFF; border-color: #1A1A1A; }
        .mode-btn.active { background: #1A1A1A; color: #FFFFFF; border-color: #1A1A1A; }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #D4D4D4;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            background: #FFFFFF;
            color: #1A1A1A;
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #1A1A1A;
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
        }

        input::placeholder { color: #A0A0A0; }

        .btn {
            padding: 12px 32px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-primary { background: #DC2626; color: #FFFFFF; }
        .btn-primary:hover:not(:disabled) { background: #B91C1C; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; background: #D4D4D4; color: #666666; }

        .btn-export {
            padding: 10px 24px;
            background: #1A1A1A;
            color: #FFFFFF;
            border: 1px solid #1A1A1A;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .btn-export:hover:not(:disabled) { background: #FFFFFF; color: #1A1A1A; }
        .btn-export:disabled { opacity: 0.6; cursor: not-allowed; }

        .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .history-card { background: #FFFFFF; border: 1px solid #E5E5E5; padding: 20px; cursor: pointer; transition: all 0.2s ease; }
        .history-card:hover { border-color: #1A1A1A; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
        .history-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #E5E5E5; }
        .history-icon { font-size: 32px; }
        .history-number { font-size: 12px; font-weight: 600; color: #666666; background: #FAFAFA; padding: 4px 12px; border: 1px solid #E5E5E5; }
        .history-card-body { margin-bottom: 16px; }
        .history-title { font-size: 16px; font-weight: 600; color: #1A1A1A; margin-bottom: 12px; }
        .history-meta { display: flex; flex-direction: column; gap: 6px; font-size: 13px; color: #666666; }
        .history-date, .history-time, .history-size { display: flex; align-items: center; gap: 8px; }
        .history-card-footer { display: flex; gap: 8px; }
        .history-btn-view, .history-btn-download { flex: 1; padding: 10px 16px; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: all 0.2s ease; border: 1px solid; font-family: 'Inter', sans-serif; }
        .history-btn-view { background: #1A1A1A; color: #FFFFFF; border-color: #1A1A1A; }
        .history-btn-view:hover { background: #FFFFFF; color: #1A1A1A; }
        .history-btn-download { background: #FFFFFF; color: #1A1A1A; border-color: #D4D4D4; }
        .history-btn-download:hover { border-color: #1A1A1A; background: #FAFAFA; }
        @media (max-width: 768px) { .history-grid { grid-template-columns: 1fr; } }

        .history-table-container { overflow-x: auto; border: 1px solid #E5E5E5; background: #FFFFFF; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        .history-table thead { background: #FAFAFA; border-bottom: 2px solid #E5E5E5; }
        .history-table th { padding: 12px 16px; text-align: left; font-weight: 600; color: #1A1A1A; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; white-space: nowrap; user-select: none; }
        .history-table th:hover { background: #F0F0F0; }
        .history-table tbody tr { border-bottom: 1px solid #E5E5E5; transition: background 0.2s ease; position: relative; }
        .history-table tbody tr:hover { background: #FAFAFA; }
        .history-table td { padding: 12px 16px; color: #1A1A1A; vertical-align: middle; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .type-badge { display: inline-block; padding: 4px 10px; font-size: 11px; font-weight: 500; text-transform: capitalize; border: 1px solid #D4D4D4; background: #FFFFFF; color: #666666; }
        .type-badge.github_repository { border-color: #1A1A1A; background: #1A1A1A; color: #FFFFFF; }
        .type-badge.local_directory { border-color: #666666; background: #666666; color: #FFFFFF; }
        .type-badge.sbom_file { border-color: #A0A0A0; background: #FFFFFF; color: #666666; }
        .type-badge.backup { border-color: #666666; background: #FAFAFA; color: #666666; font-weight: 600; }

        .findings-badge { display: inline-block; padding: 4px 10px; font-weight: 600; background: #FAFAFA; border: 1px solid #E5E5E5; min-width: 30px; text-align: center; }

        .table-btn-view, .table-btn-download { padding: 6px 12px; margin: 0 4px; border: 1px solid #D4D4D4; background: #FFFFFF; cursor: pointer; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s ease; font-family: 'Inter', sans-serif; color: #1A1A1A; }
        .table-btn-view:hover { background: #1A1A1A; color: #FFFFFF; border-color: #1A1A1A; }
        .table-btn-download:hover { background: #FAFAFA; border-color: #1A1A1A; }
        @media (max-width: 768px) { .history-table { font-size: 12px; } .history-table th, .history-table td { padding: 8px 12px; } }

        .status-bar { padding: 16px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; border: 1px solid #E5E5E5; background: #FFFFFF; font-size: 14px; font-weight: 500; }
        .status-bar.idle { border-left: 3px solid #666666; }
        .status-bar.running { border-left: 3px solid #1A1A1A; }
        .status-bar.completed { border-left: 3px solid #1A1A1A; }
        .status-bar.failed { border-left: 3px solid #DC2626; }

        .spinner { width: 16px; height: 16px; border: 2px solid #E5E5E5; border-top-color: #1A1A1A; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes countUp { from { opacity: 0.7; transform: translateY(-2px); } to { opacity: 1; transform: translateY(0); } }

        .logs-container { background: #1A1A1A; color: #E5E5E5; padding: 24px; border: 1px solid #E5E5E5; max-height: 450px; overflow-y: auto; font-family: 'SF Mono', 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.8; }
        .log-entry { margin-bottom: 8px; padding: 4px 0; border-left: 2px solid transparent; padding-left: 12px; }
        .log-timestamp { color: #666666; font-weight: 500; }
        .log-level { font-weight: 600; margin: 0 8px; padding: 2px 6px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; }
        .log-level.info { color: #E5E5E5; border: 1px solid #666666; }
        .log-level.success { color: #FFFFFF; background: #1A1A1A; border: 1px solid #FFFFFF; }
        .log-level.error { color: #FFFFFF; background: #DC2626; border: 1px solid #DC2626; }
        .log-level.warning { color: #1A1A1A; background: #FFFFFF; border: 1px solid #FFFFFF; }

        .report-container { padding: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif; }
        .report-container * { font-family: inherit; }
        .report-section { margin-bottom: 40px; padding: 32px; background: #FAFAFA; border: 1px solid #E5E5E5; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif; }
        .report-section h3 { margin-bottom: 24px; color: #1A1A1A; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 2px solid #1A1A1A; padding-bottom: 12px; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif; }
        .report-section p { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif; margin-bottom: 12px; line-height: 1.8; font-size: 14px; color: #1A1A1A; }
        .report-section p:last-child { margin-bottom: 0; }
        .report-section strong { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif; font-weight: 600; color: #1A1A1A; display: inline-block; min-width: 180px; }

        .finding-card { background: #FFFFFF; padding: 24px; margin-bottom: 16px; border: 1px solid #E5E5E5; border-left: 3px solid #666666; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif; }
        .finding-card.critical { border-left-color: #DC2626; }
        .finding-card.high { border-left-color: #1A1A1A; }
        .finding-card.medium { border-left-color: #666666; }
        .finding-card.low { border-left-color: #D4D4D4; }

        .finding-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; cursor: pointer; user-select: none; position: relative; padding-right: 40px; }
        .finding-header:hover { background: #FAFAFA; }
        .finding-header::after { content: '▼'; position: absolute; right: 24px; font-size: 10px; color: #666666; transition: transform 0.2s ease; }
        .finding-card.collapsed .finding-header::after { transform: rotate(-90deg); }
        .finding-body { display: block; }
        .finding-card.collapsed .finding-body { display: none; }
        .finding-package { font-weight: 600; font-size: 15px; color: #1A1A1A; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif; }

        .severity-badge { padding: 4px 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; border: 1px solid; }
        .severity-badge.critical { background: #DC2626; color: #FFFFFF; border-color: #DC2626; }
        .severity-badge.high { background: #1A1A1A; color: #FFFFFF; border-color: #1A1A1A; }
        .severity-badge.medium { background: #FFFFFF; color: #666666; border-color: #666666; }
        .severity-badge.low { background: #FFFFFF; color: #A0A0A0; border-color: #D4D4D4; }

        .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 40px; }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }

        .stat-card { background: #FFFFFF; padding: 32px 24px; text-align: center; border: 1px solid #E5E5E5; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; animation: fadeInUp 0.6s ease-out backwards; }
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        .stat-card:nth-child(5) { animation-delay: 0.5s; }
        .stat-card:nth-child(6) { animation-delay: 0.6s; }
        .stat-card:hover { background: #FAFAFA; border-color: #1A1A1A; transform: translateY(-4px) scale(1.02); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); }
        .stat-card.active { background: #1A1A1A; border-color: #1A1A1A; }
        .stat-card.active .stat-value { color: #FFFFFF !important; }
        .stat-card.active .stat-label { color: #FFFFFF; }
        .stat-value { font-size: 48px; font-weight: 600; color: #1A1A1A; line-height: 1; margin-bottom: 8px; }
        .stat-card.critical .stat-value { color: #DC2626; }
        .stat-label { color: #666666; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }

        .no-report { text-align: center; padding: 80px 20px; color: #A0A0A0; background: #FAFAFA; border: 1px solid #E5E5E5; }
        .no-report h3 { color: #1A1A1A; margin-bottom: 8px; font-size: 18px; font-weight: 600; }
        .no-report p { font-size: 14px; }
        .no-report svg { width: 64px; height: 64px; margin-bottom: 24px; opacity: 0.2; stroke: #1A1A1A; }

        .recent-scan-item { background: #FFFFFF; border: 1px solid #E5E5E5; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; }
        .recent-scan-item:hover { border-color: #1A1A1A; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
        .recent-scan-item:last-child { margin-bottom: 0; }
        .recent-scan-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .recent-scan-name { font-weight: 600; font-size: 14px; color: #1A1A1A; }
        .recent-scan-badge { padding: 2px 8px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; border: 1px solid; }
        .recent-scan-badge.critical { background: #DC2626; color: #FFFFFF; border-color: #DC2626; }
        .recent-scan-badge.high { background: #1A1A1A; color: #FFFFFF; border-color: #1A1A1A; }
        .recent-scan-badge.medium { background: #FFFFFF; color: #666666; border-color: #666666; }
        .recent-scan-badge.low { background: #FFFFFF; color: #A0A0A0; border-color: #D4D4D4; }
        .recent-scan-badge.clean { background: #FFFFFF; color: #1A1A1A; border-color: #1A1A1A; }
        .recent-scan-meta { font-size: 12px; color: #666666; display: flex; justify-content: space-between; align-items: center; }
        @media (max-width: 1024px) { #dashboard > div[style*="grid-template-columns: 1fr 1fr"] { grid-template-columns: 1fr !important; } }

        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; max-width: 400px; }
        .toast { background: #1A1A1A; color: #FFFFFF; padding: 16px 20px; border-left: 4px solid #FFFFFF; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; font-size: 14px; min-width: 300px; }
        .toast.success { border-left-color: #4ADE80; }
        .toast.error { border-left-color: #DC2626; }
        .toast.warning { border-left-color: #FBBF24; }
        .toast.info { border-left-color: #60A5FA; }
        .toast-close { margin-left: auto; cursor: pointer; opacity: 0.7; font-size: 18px; line-height: 1; }
        .toast-close:hover { opacity: 1; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
        .toast.removing { animation: slideOut 0.3s ease; }

        .skeleton { background: linear-gradient(90deg, #F0F0F0 25%, #E0E0E0 50%, #F0F0F0 75%); background-size: 200% 100%; animation: loading 1.5s ease-in-out infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .findings-lazy-load { text-align: center; padding: 20px; margin: 20px 0; }
        .findings-lazy-load button { padding: 12px 32px; background: #FFFFFF; border: 1px solid #D4D4D4; color: #1A1A1A; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease; }
        .findings-lazy-load button:hover { background: #1A1A1A; color: #FFFFFF; border-color: #1A1A1A; }
    </style>
</head>
<body>
    <!-- Halloween Decorative Elements -->
    <div class="corner-web corner-web-top-left" aria-hidden="true"></div>
    <div class="corner-web corner-web-top-right" aria-hidden="true"></div>
    <div class="corner-web corner-web-bottom-left" aria-hidden="true"></div>
    <div class="corner-web corner-web-bottom-right" aria-hidden="true"></div>
    
    <!-- Floating Particles -->
    <div class="floating-particles" aria-hidden="true">
        <!-- Embers -->
        <div class="particle particle-ember" style="left: 10%; animation-delay: 0s; animation-duration: 12s;"></div>
        <div class="particle particle-ember" style="left: 25%; animation-delay: 3s; animation-duration: 15s;"></div>
        <div class="particle particle-ember" style="left: 45%; animation-delay: 6s; animation-duration: 13s;"></div>
        <div class="particle particle-ember" style="left: 65%; animation-delay: 2s; animation-duration: 14s;"></div>
        <div class="particle particle-ember" style="left: 80%; animation-delay: 5s; animation-duration: 16s;"></div>
        <div class="particle particle-ember" style="left: 90%; animation-delay: 8s; animation-duration: 11s;"></div>
        
        <!-- Fog -->
        <div class="particle particle-fog" style="left: 5%; top: 20%; animation-delay: 0s;"></div>
        <div class="particle particle-fog" style="left: 40%; top: 50%; animation-delay: 8s;"></div>
        <div class="particle particle-fog" style="left: 75%; top: 30%; animation-delay: 15s;"></div>
        
        <!-- Ghosts -->
        <div class="particle particle-ghost" style="left: 15%; animation-delay: 1s; animation-duration: 18s;"></div>
        <div class="particle particle-ghost" style="left: 35%; animation-delay: 7s; animation-duration: 22s;"></div>
        <div class="particle particle-ghost" style="left: 55%; animation-delay: 4s; animation-duration: 19s;"></div>
        <div class="particle particle-ghost" style="left: 75%; animation-delay: 10s; animation-duration: 21s;"></div>
        <div class="particle particle-ghost" style="left: 85%; animation-delay: 13s; animation-duration: 20s;"></div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-logo">
                    <img src="/static/icon.png" alt="Spyder Logo">
                </div>
                <div class="header-text">
                    <h1>Spyder</h1>
                    <p>AI-Powered Supply Chain Security Scanner</p>
                </div>
                <div class="header-badges">
                    <div class="header-badge status">System Ready</div>
                    <div class="header-badge">v1.0</div>
                    <div class="header-badge">AI Enhanced</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="switchTab('report')">Report</div>
            <div class="tab" onclick="switchTab('history')">History</div>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" style="margin-bottom: 32px; grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card">
                    <div class="stat-value" id="dash-total-scans">0</div>
                    <div class="stat-label">Total Scans</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dash-total-threats">0</div>
                    <div class="stat-label">Threats Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dash-total-packages">0</div>
                    <div class="stat-label">Vulnerable Packages Found</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 32px;">
                <div class="control-panel" style="margin-bottom: 0; min-height: 400px;">
                    <h2 style="margin-bottom: 20px; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #1A1A1A;">Scan</h2>
                    
                    <div class="form-group">
                        <label>Analysis Mode</label>
                        <div class="mode-toggle">
                            <button class="mode-btn active" onclick="setMode('github')">GitHub</button>
                            <button class="mode-btn" onclick="setMode('local')">Local</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ecosystem</label>
                        <div class="mode-toggle">
                            <button class="mode-btn active" onclick="setEcosystem('npm')" id="ecosystem-npm">npm (JavaScript)</button>
                            <button class="mode-btn" onclick="setEcosystem('pypi')" id="ecosystem-pypi">Python (PyPI)</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="target">Target</label>
                        <input type="text" id="target" placeholder="Enter GitHub repository URL or local path">
                    </div>

                    <button class="btn btn-primary" id="analyze-btn" onclick="startAnalysis()" style="width: 100%;">Start Analysis</button>
                    <button class="btn btn-primary" id="cancel-btn" onclick="cancelAnalysis()" style="width: 100%; display: none; background: #666666;">Cancel Analysis</button>
                </div>

                <div style="background: #FAFAFA; padding: 32px; border: 1px solid #E5E5E5; border-radius: 4px; min-height: 400px;">
                    <h2 style="margin-bottom: 20px; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #1A1A1A;">Recent Scans</h2>
                    <div id="recent-scans-list">
                        <div style="text-align: center; padding: 40px 20px; color: #A0A0A0; font-size: 13px;">No scans yet</div>
                    </div>
                </div>
            </div>

            <div id="status-container"></div>

            <div class="logs-container" id="logs" style="max-height: 300px;">
                <div class="log-entry">
                    <span class="log-timestamp">[Ready]</span>
                    <span class="log-level info">[INFO]</span>
                    <span>System ready. Configure analysis and click "Start Analysis"</span>
                </div>
            </div>
        </div>

        <div id="report" class="tab-content">
            <div class="report-container" id="report-content">
                <div class="no-report">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3>No Report Available</h3>
                    <p>Run an analysis to generate a security report</p>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <h2 style="margin-bottom: 24px; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #1A1A1A;">Report History</h2>
            
            <div style="background: #FAFAFA; border: 1px solid #E5E5E5; padding: 12px 16px; margin-bottom: 24px; font-size: 14px; color: #666666;">
                <strong>Tip:</strong> Search and sort your analysis reports. Click on any row to view the full report.
            </div>

            <div style="margin-bottom: 20px;">
                <input type="text" id="history-search" placeholder="Search by report name, type, or date..." style="width: 100%; padding: 12px 16px; border: 1px solid #D4D4D4; font-size: 14px; font-family: 'Inter', sans-serif;" onkeyup="filterHistoryTable()">
            </div>

            <div id="history-list">
                <div style="text-align: center; padding: 60px 20px; color: #A0A0A0;">
                    <p>Loading report history...</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        let currentMode = 'github';
        let currentEcosystem = 'npm';
        let pollingInterval = null;
        let pollCount = 0;
        const INITIAL_POLL_INTERVAL = 500;
        const NORMAL_POLL_INTERVAL = 2000;
        
        let currentDisplayPercentage = 0;
        let targetPercentage = 0;
        let progressAnimationFrame = null;
        let findingsPage = 1;
        const FINDINGS_PER_PAGE = 20;

        const placeholders = {
            github: 'Enter GitHub repository URL (e.g., https://github.com/owner/repo)',
            local: 'Enter local directory path (e.g., C:\\Projects\\myapp or /home/user/myapp)'
        };

        function highlightInputError(inputElement) {
            inputElement.style.borderColor = '#DC2626';
            inputElement.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
            inputElement.focus();
            setTimeout(() => { inputElement.style.borderColor = ''; inputElement.style.boxShadow = ''; }, 3000);
        }

        function showToast(message, type = 'info', duration = 5000) {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${escapeHtml(message)}</span><span class="toast-close" onclick="this.parentElement.remove()">×</span>`;
            container.appendChild(toast);
            if (duration > 0) {
                setTimeout(() => { toast.classList.add('removing'); setTimeout(() => toast.remove(), 300); }, duration);
            }
            return toast;
        }

        async function cancelAnalysis() {
            const cancelBtn = document.getElementById('cancel-btn');
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'Cancelling...';
            try {
                const response = await fetch('/api/cancel', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                if (response.ok) { showToast('Analysis cancellation requested', 'warning'); }
                else { const error = await response.json(); showToast('Error: ' + error.error, 'error'); cancelBtn.disabled = false; cancelBtn.textContent = 'Cancel Analysis'; }
            } catch (error) { showToast('Error: ' + error.message, 'error'); cancelBtn.disabled = false; cancelBtn.textContent = 'Cancel Analysis'; }
        }

        function showReportTab() { const reportTab = document.getElementById('report-tab'); if (reportTab) reportTab.style.display = 'block'; }
        function hideReportTab() { const reportTab = document.getElementById('report-tab'); if (reportTab) reportTab.style.display = 'none'; }

        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (event && event.target) { event.target.classList.add('active'); }
            else { document.querySelectorAll('.tab').forEach(tab => { if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(tabName)) tab.classList.add('active'); }); }
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'dashboard') loadDashboard();
            else if (tabName === 'report') loadReport();
            else if (tabName === 'history') loadReportHistory();
        }

        function setMode(mode) {
            currentMode = mode;
            const modeButtons = document.querySelectorAll('.mode-toggle')[0].querySelectorAll('.mode-btn');
            modeButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('target').placeholder = placeholders[mode];
        }

        function setEcosystem(ecosystem) {
            currentEcosystem = ecosystem;
            document.getElementById('ecosystem-npm').classList.remove('active');
            document.getElementById('ecosystem-pypi').classList.remove('active');
            event.target.classList.add('active');
        }

        async function loadDashboard() {
            document.getElementById('dash-total-scans').textContent = '...';
            document.getElementById('dash-total-threats').textContent = '...';
            document.getElementById('dash-total-packages').textContent = '...';
            document.getElementById('recent-scans-list').innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #A0A0A0; font-size: 13px;"><div class="spinner" style="margin: 0 auto 12px;"></div>Loading...</div>';
            
            try {
                const response = await fetch('/api/reports?per_page=10&page=1');
                const data = await response.json();
                const reports = data.reports || [];
                let totalScans = reports.length, totalThreats = 0, totalPackages = 0;

                for (const report of reports) {
                    try {
                        const dataResponse = await fetch(`/outputs/${report.filename}`);
                        const data = await dataResponse.json();
                        const securityFindings = data.security_findings || {};
                        const packages = securityFindings.packages || [];
                        let findingsCount = 0;
                        packages.forEach(pkg => { findingsCount += (pkg.findings || []).length; });
                        totalThreats += findingsCount;
                        totalPackages += packages.length;
                    } catch (e) {}
                }
                
                const reportsWithData = await Promise.all(
                    reports.slice(0, 10).map(async (report) => {
                        try {
                            const dataResponse = await fetch(`/outputs/${report.filename}`);
                            const data = await dataResponse.json();
                            const metadata = data.metadata || {};
                            const securityFindings = data.security_findings || {};
                            const packages = securityFindings.packages || [];
                            let findingsCount = 0;
                            packages.forEach(pkg => { findingsCount += (pkg.findings || []).length; });
                            return { filename: report.filename, name: extractReportName(metadata.target), date: report.modified, findings: findingsCount, severity: getHighestSeverityFromPackages(packages), metadata: metadata };
                        } catch (e) { return null; }
                    })
                );

                document.getElementById('dash-total-scans').textContent = totalScans;
                document.getElementById('dash-total-threats').textContent = totalThreats;
                document.getElementById('dash-total-packages').textContent = totalPackages;
                renderRecentScans(reportsWithData.filter(r => r !== null).slice(0, 3));
            } catch (error) { console.error('Error loading dashboard:', error); }
        }

        function getHighestSeverityFromPackages(packages) {
            if (!packages || packages.length === 0) return 'clean';
            const severities = ['critical', 'high', 'medium', 'low'];
            for (const sev of severities) {
                for (const pkg of packages) {
                    const findings = pkg.findings || [];
                    if (findings.some(f => f.severity === sev)) return sev;
                }
            }
            return 'low';
        }

        function renderRecentScans(scans) {
            const container = document.getElementById('recent-scans-list');
            if (scans.length === 0) { container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #A0A0A0; font-size: 13px;">No scans yet</div>'; return; }
            container.innerHTML = scans.map(scan => {
                const date = new Date(scan.date);
                const timeStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const badgeText = scan.findings === 0 ? 'Clean' : `${scan.findings} ${scan.findings === 1 ? 'threat' : 'threats'}`;
                const badgeClass = scan.findings === 0 ? 'clean' : scan.severity;
                return `<div class="recent-scan-item" onclick="loadHistoricalReport('${scan.filename}')"><div class="recent-scan-header"><div class="recent-scan-name">${escapeHtml(scan.name)}</div><span class="recent-scan-badge ${badgeClass}">${badgeText}</span></div><div class="recent-scan-meta"><span>${timeStr}</span><span>${scan.metadata.analysis_type || 'unknown'}</span></div></div>`;
            }).join('');
        }

        async function startAnalysis() {
            const targetInput = document.getElementById('target');
            const target = targetInput.value.trim();
            targetInput.style.borderColor = ''; targetInput.style.boxShadow = '';
            if (!target) { showToast('Please enter a target (GitHub URL or local path)', 'error'); highlightInputError(targetInput); return; }
            if (currentMode === 'github') {
                const githubUrlPattern = /^https?:\/\/(www\.)?github\.com\/[\w-]+\/[\w.-]+/i;
                if (!githubUrlPattern.test(target)) { showToast('Invalid GitHub URL. Please enter a valid GitHub repository URL (e.g., https://github.com/user/repo)', 'error'); highlightInputError(targetInput); return; }
            } else if (currentMode === 'local') {
                const isWindowsPath = /^[a-zA-Z]:\\/.test(target) || /^\\\\/.test(target);
                const isUnixPath = /^\//.test(target) || /^~\//.test(target);
                const isRelativePath = /^\.\.?[\/\\]/.test(target) || /^[\w.-]+$/.test(target);
                if (!isWindowsPath && !isUnixPath && !isRelativePath) { showToast('Invalid local path. Please enter a valid file system path', 'error'); highlightInputError(targetInput); return; }
                if (target.startsWith('http://') || target.startsWith('https://')) { showToast('You selected "Local" mode but entered a URL. Please switch to "GitHub" mode or enter a local file path.', 'error'); highlightInputError(targetInput); return; }
            }
            currentReportData = null;
            const analyzeBtn = document.getElementById('analyze-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            analyzeBtn.style.display = 'none'; cancelBtn.style.display = 'block'; cancelBtn.disabled = false;
            try {
                const response = await fetch('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode: currentMode, target: target, ecosystem: currentEcosystem }) });
                if (response.ok) {
                    currentDisplayPercentage = 0; targetPercentage = 0;
                    if (progressAnimationFrame) { cancelAnimationFrame(progressAnimationFrame); progressAnimationFrame = null; }
                    showToast('Analysis started', 'success'); startPolling();
                } else { const error = await response.json(); showToast('Error: ' + error.error, 'error'); analyzeBtn.style.display = 'block'; cancelBtn.style.display = 'none'; }
            } catch (error) { showToast('Error: ' + error.message, 'error'); analyzeBtn.style.display = 'block'; cancelBtn.style.display = 'none'; }
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollCount = 0;
            pollingInterval = setInterval(() => {
                pollCount++;
                if (pollCount === 10) { clearInterval(pollingInterval); pollingInterval = setInterval(updateStatus, NORMAL_POLL_INTERVAL); }
                updateStatus();
            }, INITIAL_POLL_INTERVAL);
            updateStatus();
        }

        function stopPolling() { if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; } }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateStatusBar(data); updateLogs(data.logs);
                if (data.running && data.progress && data.progress.percentage >= 100) { console.log('Progress reached 100%, waiting 2 seconds...'); setTimeout(() => { updateStatus(); }, 2000); return; }
                if (!data.running) {
                    stopPolling();
                    const analyzeBtn = document.getElementById('analyze-btn');
                    const cancelBtn = document.getElementById('cancel-btn');
                    analyzeBtn.style.display = 'block'; cancelBtn.style.display = 'none';
                    if (data.status === 'completed') { showToast('Analysis completed successfully!', 'success'); currentReportData = null; setTimeout(() => { showReportTab(); loadReport(); switchTab('report'); }, 2000); }
                    else if (data.status === 'cancelled') { showToast('Analysis was cancelled', 'warning'); }
                    else if (data.status === 'failed') { showToast('Analysis failed. Check logs for details.', 'error'); }
                }
            } catch (error) { console.error('Error updating status:', error); }
        }

        function updateStatusBar(data) {
            const container = document.getElementById('status-container');
            const statusClass = data.status || 'idle';
            let statusText = { idle: 'Idle', running: 'Analysis in progress...', completed: 'Analysis completed', failed: 'Analysis failed' }[statusClass];
            let html = `<div class="status-bar ${statusClass}">`;
            if (data.running) html += '<div class="spinner"></div>';
            html += `<strong>${statusText}</strong>`;
            if (data.start_time) html += ` <span style="margin-left: auto; opacity: 0.8;">Started: ${new Date(data.start_time).toLocaleTimeString()}</span>`;
            html += '</div>';
            
            if (data.running) {
                const progress = data.progress || {};
                const serverPercentage = progress.percentage || 0;
                const current = progress.scanned_packages || 0;
                const total = progress.total_packages || 0;
                const currentPkg = progress.current_package || 'Initializing...';
                targetPercentage = serverPercentage;
                if (!progressAnimationFrame) animateProgress();
                const displayText = (total === 0 || current === 0) ? 'Initializing scan...' : `Scanning Progress: ${current} / ${total} packages`;
                html += `<div style="background: #FFFFFF; border: 1px solid #E5E5E5; padding: 16px; margin-bottom: 24px; transition: all 0.3s ease;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><div style="font-size: 13px; font-weight: 600; color: #1A1A1A; transition: all 0.3s ease;">${displayText}</div><div id="progress-percentage" style="font-size: 14px; font-weight: 700; color: #1A1A1A; transition: all 0.3s ease;">${Math.round(currentDisplayPercentage)}%</div></div><div style="width: 100%; height: 8px; background: #E5E5E5; border-radius: 4px; overflow: hidden; margin-bottom: 8px;"><div id="progress-bar-fill" style="width: ${currentDisplayPercentage}%; height: 100%; background: linear-gradient(90deg, #1A1A1A 0%, #666666 100%); transition: none;"></div></div>${currentPkg ? `<div style="font-size: 12px; color: #666666; font-family: 'SF Mono', 'Monaco', monospace;">Currently scanning: <span style="color: #1A1A1A; font-weight: 600;">${escapeHtml(currentPkg)}</span></div>` : ''}</div>`;
            }
            container.innerHTML = html;
        }
        
        function animateProgress() {
            const diff = targetPercentage - currentDisplayPercentage;
            if (Math.abs(diff) < 0.1) {
                currentDisplayPercentage = targetPercentage;
                const fillElement = document.getElementById('progress-bar-fill');
                const percentElement = document.getElementById('progress-percentage');
                if (fillElement) fillElement.style.width = currentDisplayPercentage + '%';
                if (percentElement) percentElement.textContent = Math.round(currentDisplayPercentage) + '%';
                if (currentDisplayPercentage >= targetPercentage) { progressAnimationFrame = null; return; }
            } else {
                currentDisplayPercentage += diff * 0.05;
                const fillElement = document.getElementById('progress-bar-fill');
                const percentElement = document.getElementById('progress-percentage');
                if (fillElement) fillElement.style.width = currentDisplayPercentage + '%';
                if (percentElement) percentElement.textContent = Math.round(currentDisplayPercentage) + '%';
            }
            progressAnimationFrame = requestAnimationFrame(animateProgress);
        }

        function updateLogs(logs) {
            const logsContainer = document.getElementById('logs');
            const shouldScroll = logsContainer.scrollHeight - logsContainer.scrollTop <= logsContainer.clientHeight + 50;
            logsContainer.innerHTML = logs.map(log => {
                const levelClass = log.level || 'info';
                return `<div class="log-entry"><span class="log-timestamp">[${log.timestamp}]</span><span class="log-level ${levelClass}">[${log.level.toUpperCase()}]</span><span>${escapeHtml(log.message)}</span></div>`;
            }).join('');
            if (shouldScroll) logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        async function loadReport() {
            const reportContent = document.getElementById('report-content');
            try {
                const cacheBuster = new Date().getTime();
                const response = await fetch(`/api/report?t=${cacheBuster}`, { cache: 'no-store', headers: { 'Cache-Control': 'no-cache' } });
                if (!response.ok) { reportContent.innerHTML = '<div class="no-report"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><h3>No Report Available</h3><p>Run an analysis to generate a security report</p></div>'; return; }
                const data = await response.json();
                renderReport(data);
            } catch (error) { console.error('Error loading report:', error); reportContent.innerHTML = `<div class="no-report"><h3>Error Loading Report</h3><p>${escapeHtml(error.message)}</p></div>`; }
        }

        let currentReportData = null;
        let currentFilter = null;
        let displayedFindings = FINDINGS_PER_PAGE;

        function filterFindings(severity) {
            if (!currentReportData) return;
            if (currentFilter === severity) currentFilter = null;
            else currentFilter = severity;
            displayedFindings = FINDINGS_PER_PAGE;
            renderReport(currentReportData);
        }

        function loadMoreFindings() { displayedFindings += FINDINGS_PER_PAGE; renderReport(currentReportData); }

        function renderFindingsSection(findings, sectionType) {
            if (findings.length === 0) return '<p>No findings detected.</p>';
            const packageGroups = {};
            findings.forEach(finding => {
                const pkgKey = `${finding.package || 'Unknown'}@${finding.version || 'unknown'}`;
                if (!packageGroups[pkgKey]) packageGroups[pkgKey] = { package: finding.package || 'Unknown', version: finding.version || 'unknown', findings: [] };
                packageGroups[pkgKey].findings.push(finding);
            });
            let html = '<div style="margin-top: 16px;">';
            Object.values(packageGroups).forEach(pkgGroup => {
                // Get highest severity
                const highestSeverity = pkgGroup.findings.reduce((max, f) => { const severities = ['low', 'medium', 'high', 'critical']; const currentIdx = severities.indexOf(f.severity); const maxIdx = severities.indexOf(max); return currentIdx > maxIdx ? f.severity : max; }, 'low');
                
                // Collect all CVE/GHSA IDs
                const vulnIds = [...new Set(pkgGroup.findings.map(f => f.id).filter(id => id && id !== 'N/A'))];
                
                // Build consolidated summary paragraph - show all descriptions without truncation
                const descriptions = [...new Set(pkgGroup.findings.map(f => f.summary || f.description).filter(d => d))];
                const summaryText = descriptions.join('. ');
                
                // Collect sources
                const sources = [...new Set(pkgGroup.findings.map(f => f.source).filter(s => s))];
                
                // Average confidence
                const avgConfidence = pkgGroup.findings.reduce((sum, f) => sum + (f.confidence || 0.85), 0) / pkgGroup.findings.length;
                
                // Severity color
                const severityColor = highestSeverity === 'critical' ? '#DC2626' : highestSeverity === 'high' ? '#EA580C' : highestSeverity === 'medium' ? '#D97706' : '#16A34A';
                
                html += `<div style="background: #FFFFFF; border: 1px solid #E5E5E5; border-left: 4px solid ${severityColor}; padding: 20px; margin-bottom: 16px; border-radius: 4px;">`;
                
                // Header: Package name + severity badge
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">`;
                html += `<div style="font-size: 16px; font-weight: 700; color: #1A1A1A;">${escapeHtml(pkgGroup.package)} <span style="font-weight: 400; color: #666;">${pkgGroup.version !== 'unknown' ? 'v' + escapeHtml(pkgGroup.version) : ''}</span></div>`;
                html += `<span class="severity-badge ${highestSeverity}">${highestSeverity.toUpperCase()}</span>`;
                html += `</div>`;
                
                // CVE/GHSA IDs as clickable badges
                if (vulnIds.length > 0) {
                    html += `<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">`;
                    vulnIds.forEach(id => { html += `<span style="background: #FEF2F2; color: #DC2626; padding: 4px 8px; font-size: 11px; font-weight: 600; border-radius: 2px; border: 1px solid #FECACA;">${makeCVEClickable(id)}</span>`; });
                    html += `</div>`;
                }
                
                // Summary paragraph
                html += `<p style="font-size: 14px; color: #374151; line-height: 1.6; margin: 0 0 12px 0;">${linkifyVulnerabilityIds(summaryText)}</p>`;
                
                // Footer: Sources + Confidence
                html += `<div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #6B7280;">`;
                html += `<div>Sources: ${sources.join(', ') || 'Unknown'}</div>`;
                html += `<div style="background: #F3F4F6; padding: 2px 8px; border-radius: 2px;">Confidence: ${(avgConfidence * 100).toFixed(0)}%</div>`;
                html += `</div>`;
                
                html += `</div>`;
            });
            html += '</div>';
            return html;
        }

        function renderReport(data) {
            const reportContent = document.getElementById('report-content');
            currentReportData = data;
            try {
                const metadata = data.metadata || {};
                const supplyChainAnalysis = data.supply_chain_analysis || {};
                const securityFindings = data.security_findings || {};
                const packages = securityFindings.packages || [];
                
                // Build findings from security_findings.packages (contains both rule-based and agent-based)
                const allFindings = [];
                let ruleBasedCount = 0;
                let agentBasedCount = 0;
                
                // Helper to extract CVE/GHSA from description text
                function extractVulnIds(text) {
                    const ids = [];
                    const cveMatch = text.match(/CVE-\d{4}-\d{4,}/gi);
                    const ghsaMatch = text.match(/GHSA-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}/gi);
                    if (cveMatch) ids.push(...cveMatch.map(id => id.toUpperCase()));
                    if (ghsaMatch) ids.push(...ghsaMatch.map(id => id.toUpperCase()));
                    return ids;
                }
                
                // First pass: collect all CVE/GHSA IDs from security_advisory findings
                const knownVulnIds = new Set();
                packages.forEach(pkg => {
                    (pkg.findings || []).forEach(finding => {
                        if (finding.type === 'security_advisory') {
                            if (finding.evidence?.ghsa_id) knownVulnIds.add(finding.evidence.ghsa_id.toUpperCase());
                            if (finding.evidence?.cve_id) knownVulnIds.add(finding.evidence.cve_id.toUpperCase());
                        }
                    });
                });
                
                // Track seen CVEs in web_intelligence to avoid duplicates within that section too
                const seenWebIntelCves = new Set();
                
                packages.forEach(pkg => {
                    const findings = pkg.findings || [];
                    findings.forEach(finding => {
                        const findingType = finding.type || 'unknown';
                        const isRuleBased = findingType === 'security_advisory';
                        
                        // For web_intelligence, deduplicate
                        if (!isRuleBased) {
                            const desc = finding.description || '';
                            const title = finding.evidence?.title || '';
                            const extractedIds = extractVulnIds(desc + ' ' + title);
                            
                            // Skip if references a CVE from security_advisory
                            if (extractedIds.some(id => knownVulnIds.has(id))) return;
                            
                            // Skip if we've already seen this CVE in web_intelligence (avoid duplicate NVD/GitHub pages)
                            if (extractedIds.length > 0) {
                                const isDuplicateWebIntel = extractedIds.some(id => seenWebIntelCves.has(id));
                                if (isDuplicateWebIntel) return;
                                // Mark these CVEs as seen
                                extractedIds.forEach(id => seenWebIntelCves.add(id));
                            }
                        }
                        
                        if (isRuleBased) ruleBasedCount++;
                        else agentBasedCount++;
                        
                        allFindings.push({
                            package: pkg.name,
                            version: pkg.version || '*',
                            ecosystem: pkg.ecosystem || 'npm',
                            severity: finding.severity || 'medium',
                            finding_type: findingType,
                            id: finding.evidence?.ghsa_id || finding.evidence?.cve_id || 'N/A',
                            summary: finding.description || 'No description',
                            details: finding.description || '',
                            cvss_score: finding.evidence?.cvss_score || 'N/A',
                            affected_versions: [],
                            fixed_versions: [],
                            references: finding.evidence?.url ? [finding.evidence.url] : [],
                            confidence: finding.confidence || 0.85,
                            remediation: finding.remediation || '',
                            evidence: finding.evidence || {},
                            source: finding.source || 'unknown',
                            isRuleBased: isRuleBased
                        });
                    });
                });
                
                const findings = currentFilter ? allFindings.filter(f => f.severity === currentFilter) : allFindings;
                const severityCounts = { critical: allFindings.filter(f => f.severity === 'critical').length, high: allFindings.filter(f => f.severity === 'high').length, medium: allFindings.filter(f => f.severity === 'medium').length, low: allFindings.filter(f => f.severity === 'low').length };
                const uniquePackages = new Set(allFindings.map(f => `${f.package || 'Unknown'}@${f.version || 'unknown'}`));
                const vulnerablePackagesCount = uniquePackages.size;

                let scanResult = 'green', scanResultText = 'ALL CLEAR', scanResultBg = '#22C55E', scanResultBorder = '#16A34A', scanResultMessage = 'No security issues detected';
                if (severityCounts.critical > 0) { scanResult = 'red'; scanResultText = 'CRITICAL ATTENTION REQUIRED'; scanResultBg = '#DC2626'; scanResultBorder = '#B91C1C'; scanResultMessage = `${severityCounts.critical} critical ${severityCounts.critical === 1 ? 'issue' : 'issues'} found - immediate action required`; }
                else if (severityCounts.high > 0 || severityCounts.medium > 0) { scanResult = 'amber'; scanResultText = 'REVIEW RECOMMENDED'; scanResultBg = '#F59E0B'; scanResultBorder = '#D97706'; scanResultMessage = `${severityCounts.high + severityCounts.medium} ${severityCounts.high + severityCounts.medium === 1 ? 'issue' : 'issues'} requiring review`; }

                let html = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h2 style="margin: 0;">Security Analysis Report</h2><button onclick="exportToPDF()" class="btn btn-export">Export PDF</button></div>`;
                html += `<div style="background: ${scanResultBg}; color: #FFFFFF; padding: 16px 24px; margin-bottom: 24px; border-left: 4px solid ${scanResultBorder}; display: flex; align-items: center; gap: 12px;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${scanResult === 'green' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>' : scanResult === 'amber' ? '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' : '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>'}</svg><div style="flex: 1;"><div style="font-size: 14px; font-weight: 700; margin-bottom: 2px;">${scanResultText}</div><div style="font-size: 12px; opacity: 0.9;">${scanResultMessage}</div></div></div>`;
                
                html += `<div class="report-section" style="background: #FFFFFF; border: 1px solid #E5E5E5; padding: 0;"><div style="background: #1A1A1A; color: #FFFFFF; padding: 16px 32px; border-bottom: 1px solid #E5E5E5;"><h3 style="margin: 0; color: #FFFFFF; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; border: none; padding: 0;">Analysis Metadata</h3></div><div style="padding: 32px;"><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px;"><div style="border-left: 3px solid #1A1A1A; padding-left: 16px;"><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666666; margin-bottom: 8px;">Target</div><div style="font-size: 15px; font-weight: 600; color: #1A1A1A; word-break: break-word;">${escapeHtml(extractReportName(metadata.target) || 'N/A')}</div></div><div style="border-left: 3px solid #1A1A1A; padding-left: 16px;"><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666666; margin-bottom: 8px;">Timestamp</div><div style="font-size: 15px; font-weight: 600; color: #1A1A1A;">${(metadata.timestamp || metadata.start_time) ? new Date(metadata.timestamp || metadata.start_time).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'}</div></div><div style="border-left: 3px solid #1A1A1A; padding-left: 16px;"><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666666; margin-bottom: 8px;">Confidence</div><div style="font-size: 15px; font-weight: 600; color: #1A1A1A;">${metadata.confidence ? (metadata.confidence * 100).toFixed(0) + '%' : (supplyChainAnalysis.confidence ? (supplyChainAnalysis.confidence * 100).toFixed(0) + '%' : (allFindings.length > 0 ? '85%' : 'N/A'))}</div></div></div></div></div>`;
                
                // Separate findings into rule-based and agent-based
                const ruleBasedFindings = allFindings.filter(f => f.isRuleBased);
                const agentBasedFindings = allFindings.filter(f => !f.isRuleBased);
                
                // Count unique packages for each type
                const ruleBasedPkgs = new Set(ruleBasedFindings.map(f => `${f.package}@${f.version}`));
                const agentBasedPkgs = new Set(agentBasedFindings.map(f => `${f.package}@${f.version}`));
                
                // Severity counts for rule-based
                const ruleBasedSeverity = { critical: ruleBasedFindings.filter(f => f.severity === 'critical').length, high: ruleBasedFindings.filter(f => f.severity === 'high').length, medium: ruleBasedFindings.filter(f => f.severity === 'medium').length, low: ruleBasedFindings.filter(f => f.severity === 'low').length };
                
                // Severity counts for agent-based
                const agentBasedSeverity = { critical: agentBasedFindings.filter(f => f.severity === 'critical').length, high: agentBasedFindings.filter(f => f.severity === 'high').length, medium: agentBasedFindings.filter(f => f.severity === 'medium').length, low: agentBasedFindings.filter(f => f.severity === 'low').length };
                
                // ========== SECTION 1: SECURITY ADVISORIES (GitHub/CVE/GHSA) ==========
                html += `<div class="report-section" style="background: #FFFFFF; border: 1px solid #E5E5E5; padding: 0; margin-bottom: 24px;"><div style="background: #1A1A1A; color: #FFFFFF; padding: 16px 32px; border-bottom: 1px solid #E5E5E5;"><h3 style="margin: 0; color: #FFFFFF; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; border: none; padding: 0;">Security Advisories (GitHub/CVE/GHSA)</h3></div><div style="padding: 32px; background: #FFFFFF;">`;
                
                // Rule-based summary cards
                html += `<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;"><div style="background: #FAFAFA; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: #1A1A1A; line-height: 1; margin-bottom: 4px;">${ruleBasedPkgs.size}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Packages</div></div><div style="background: ${ruleBasedSeverity.critical > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: ${ruleBasedSeverity.critical > 0 ? '#DC2626' : '#D4D4D4'}; line-height: 1; margin-bottom: 4px;">${ruleBasedSeverity.critical}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${ruleBasedSeverity.critical > 0 ? '#DC2626' : '#666'};">Critical</div></div><div style="background: ${ruleBasedSeverity.high > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: ${ruleBasedSeverity.high > 0 ? '#1A1A1A' : '#D4D4D4'}; line-height: 1; margin-bottom: 4px;">${ruleBasedSeverity.high}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${ruleBasedSeverity.high > 0 ? '#1A1A1A' : '#666'};">High</div></div><div style="background: ${ruleBasedSeverity.medium > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: ${ruleBasedSeverity.medium > 0 ? '#1A1A1A' : '#D4D4D4'}; line-height: 1; margin-bottom: 4px;">${ruleBasedSeverity.medium}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${ruleBasedSeverity.medium > 0 ? '#1A1A1A' : '#666'};">Medium</div></div><div style="background: ${ruleBasedSeverity.low > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: ${ruleBasedSeverity.low > 0 ? '#1A1A1A' : '#D4D4D4'}; line-height: 1; margin-bottom: 4px;">${ruleBasedSeverity.low}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${ruleBasedSeverity.low > 0 ? '#1A1A1A' : '#666'};">Low</div></div></div>`;
                
                if (ruleBasedFindings.length > 0) html += renderFindingsSection(ruleBasedFindings, 'advisory');
                else html += '<p style="color: #666; font-style: italic;">No security advisories found from GitHub/CVE/GHSA databases.</p>';
                html += '</div></div>';
                
                // ========== SECTION 2: WEB INTELLIGENCE (Snyk/NVD/CVE Details) ==========
                html += `<div class="report-section" style="background: #FFFFFF; border: 1px solid #E5E5E5; padding: 0;"><div style="background: #1A1A1A; color: #FFFFFF; padding: 16px 32px; border-bottom: 1px solid #E5E5E5;"><h3 style="margin: 0; color: #FFFFFF; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; border: none; padding: 0;">Web Intelligence (Snyk/NVD/CVE Details)</h3></div><div style="padding: 32px; background: #FFFFFF;">`;
                
                // Agent-based summary cards
                html += `<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;"><div style="background: #FAFAFA; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: #1A1A1A; line-height: 1; margin-bottom: 4px;">${agentBasedPkgs.size}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Packages</div></div><div style="background: ${agentBasedSeverity.critical > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: ${agentBasedSeverity.critical > 0 ? '#DC2626' : '#D4D4D4'}; line-height: 1; margin-bottom: 4px;">${agentBasedSeverity.critical}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${agentBasedSeverity.critical > 0 ? '#DC2626' : '#666'};">Critical</div></div><div style="background: ${agentBasedSeverity.high > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: ${agentBasedSeverity.high > 0 ? '#1A1A1A' : '#D4D4D4'}; line-height: 1; margin-bottom: 4px;">${agentBasedSeverity.high}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${agentBasedSeverity.high > 0 ? '#1A1A1A' : '#666'};">High</div></div><div style="background: ${agentBasedSeverity.medium > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: ${agentBasedSeverity.medium > 0 ? '#1A1A1A' : '#D4D4D4'}; line-height: 1; margin-bottom: 4px;">${agentBasedSeverity.medium}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${agentBasedSeverity.medium > 0 ? '#1A1A1A' : '#666'};">Medium</div></div><div style="background: ${agentBasedSeverity.low > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 16px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: ${agentBasedSeverity.low > 0 ? '#1A1A1A' : '#D4D4D4'}; line-height: 1; margin-bottom: 4px;">${agentBasedSeverity.low}</div><div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${agentBasedSeverity.low > 0 ? '#1A1A1A' : '#666'};">Low</div></div></div>`;
                
                if (agentBasedFindings.length > 0) html += renderFindingsSection(agentBasedFindings, 'webintel');
                else html += '<p style="color: #666; font-style: italic;">No web intelligence findings from Snyk/NVD/CVE Details.</p>';
                html += '</div></div>';

                if (data.dependency_graph && data.dependency_graph.metadata) {
                    html += `<div class="report-section" style="background: #FFFFFF; border: 1px solid #E5E5E5; padding: 0;"><div style="background: #1A1A1A; color: #FFFFFF; padding: 16px 32px; border-bottom: 1px solid #E5E5E5;"><h3 style="margin: 0; color: #FFFFFF; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; border: none; padding: 0;">Dependency Graph</h3></div><div style="padding: 32px;"><div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;"><div style="background: #FAFAFA; border: 1px solid #E5E5E5; padding: 24px; text-align: center;"><div style="font-size: 36px; font-weight: 700; color: #1A1A1A; line-height: 1; margin-bottom: 8px;">${data.dependency_graph.metadata.total_packages || 0}</div><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666666;">Total Packages</div></div><div style="background: ${data.dependency_graph.metadata.circular_dependencies_count > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 24px; text-align: center;"><div style="font-size: 36px; font-weight: 700; color: ${data.dependency_graph.metadata.circular_dependencies_count > 0 ? '#1A1A1A' : '#D4D4D4'}; line-height: 1; margin-bottom: 8px;">${data.dependency_graph.metadata.circular_dependencies_count || 0}</div><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${data.dependency_graph.metadata.circular_dependencies_count > 0 ? '#1A1A1A' : '#666666'};">Circular Dependencies</div></div><div style="background: ${data.dependency_graph.metadata.version_conflicts_count > 0 ? '#FFFFFF' : '#FAFAFA'}; border: 1px solid #E5E5E5; padding: 24px; text-align: center;"><div style="font-size: 36px; font-weight: 700; color: ${data.dependency_graph.metadata.version_conflicts_count > 0 ? '#1A1A1A' : '#D4D4D4'}; line-height: 1; margin-bottom: 8px;">${data.dependency_graph.metadata.version_conflicts_count || 0}</div><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${data.dependency_graph.metadata.version_conflicts_count > 0 ? '#1A1A1A' : '#666666'};">Version Conflicts</div></div><div style="background: #FAFAFA; border: 1px solid #E5E5E5; padding: 24px; text-align: center;"><div style="font-size: 24px; font-weight: 700; color: #1A1A1A; line-height: 1; margin-bottom: 8px; font-family: 'Courier New', monospace;">${escapeHtml(data.dependency_graph.metadata.ecosystem || 'N/A')}</div><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666666;">Ecosystem</div></div></div></div></div>`;
                }

                // Recommendations section
                const recommendations = data.recommendations || {};
                if (recommendations && (recommendations.immediate_priority || recommendations.security_hardening || recommendations.ongoing_monitoring || recommendations.immediate_actions || typeof recommendations === 'string')) {
                    html += `<div class="report-section" style="background: #FFFFFF; border: 1px solid #E5E5E5; padding: 0;"><div style="background: #1A1A1A; color: #FFFFFF; padding: 16px 32px; border-bottom: 1px solid #E5E5E5;"><h3 style="margin: 0; color: #FFFFFF; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; border: none; padding: 0;">Security Recommendations</h3></div><div style="padding: 32px;">`;
                    
                    // New professional format
                    if (recommendations.immediate_priority || recommendations.security_hardening || recommendations.ongoing_monitoring) {
                        if (recommendations.summary) {
                            html += `<div style="background: #F8FAFC; border-left: 4px solid #1A1A1A; padding: 16px 20px; margin-bottom: 24px; font-size: 15px; font-weight: 500; color: #1A1A1A;">${escapeHtml(recommendations.summary)}</div>`;
                        }
                        if (recommendations.immediate_priority) {
                            html += `<div style="margin-bottom: 24px;"><h4 style="font-size: 14px; font-weight: 600; color: #DC2626; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.05em;">Immediate Priority</h4><p style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0; text-align: justify;">${escapeHtml(recommendations.immediate_priority)}</p></div>`;
                        }
                        if (recommendations.security_hardening) {
                            html += `<div style="margin-bottom: 24px;"><h4 style="font-size: 14px; font-weight: 600; color: #D97706; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.05em;">Security Hardening</h4><p style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0; text-align: justify;">${escapeHtml(recommendations.security_hardening)}</p></div>`;
                        }
                        if (recommendations.ongoing_monitoring) {
                            html += `<div><h4 style="font-size: 14px; font-weight: 600; color: #2563EB; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.05em;">Ongoing Monitoring</h4><p style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0; text-align: justify;">${escapeHtml(recommendations.ongoing_monitoring)}</p></div>`;
                        }
                    }
                    // Legacy format support
                    else if (typeof recommendations === 'string') {
                        html += `<p style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0; text-align: justify;">${escapeHtml(recommendations)}</p>`;
                    }
                    // Old array format fallback
                    else if (recommendations.immediate_actions) {
                        const allRecs = [...(recommendations.immediate_actions || []), ...(recommendations.preventive_measures || []), ...(recommendations.monitoring || [])];
                        html += `<div style="font-size: 14px; color: #374151; line-height: 1.8;">${allRecs.map(r => `<p style="margin-bottom: 16px;">${escapeHtml(r)}</p>`).join('')}</div>`;
                    }
                    
                    html += '</div></div>';
                }

                // Performance metrics section
                if (data.performance_metrics) {
                    const pm = data.performance_metrics;
                    html += `<div class="report-section" style="background: #FFFFFF; border: 1px solid #E5E5E5; padding: 0;"><div style="background: #1A1A1A; color: #FFFFFF; padding: 16px 32px; border-bottom: 1px solid #E5E5E5;"><h3 style="margin: 0; color: #FFFFFF; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; border: none; padding: 0;">Performance Metrics</h3></div><div style="padding: 32px;"><div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;"><div style="background: #FAFAFA; border: 1px solid #E5E5E5; padding: 24px; text-align: center;"><div style="font-size: 36px; font-weight: 700; color: #22C55E; line-height: 1; margin-bottom: 8px;">${pm.stages_completed || 0}</div><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666666;">Stages Completed</div></div><div style="background: #FAFAFA; border: 1px solid #E5E5E5; padding: 24px; text-align: center;"><div style="font-size: 36px; font-weight: 700; color: ${pm.stages_failed > 0 ? '#DC2626' : '#D4D4D4'}; line-height: 1; margin-bottom: 8px;">${pm.stages_failed || 0}</div><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666666;">Stages Failed</div></div><div style="background: #FAFAFA; border: 1px solid #E5E5E5; padding: 24px; text-align: center;"><div style="font-size: 36px; font-weight: 700; color: #1A1A1A; line-height: 1; margin-bottom: 8px;">${(pm.total_duration_seconds || pm.agent_time || 0).toFixed(1)}s</div><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666666;">Analysis Time</div></div><div style="background: #FAFAFA; border: 1px solid #E5E5E5; padding: 24px; text-align: center;"><div style="font-size: 24px; font-weight: 700; color: #1A1A1A; line-height: 1; margin-bottom: 8px;">${supplyChainAnalysis.risk_level || 'N/A'}</div><div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666666;">Risk Level</div></div></div></div></div>`;
                }
                
                reportContent.innerHTML = html;
            } catch (error) { console.error('Error rendering report:', error); reportContent.innerHTML = `<div class="no-report"><h3>Error Rendering Report</h3><p>${error.message}</p><p>Check browser console for details</p></div>`; }
        }

        let allReports = [];
        let currentSortColumn = 'date';
        let currentSortDirection = 'desc';

        function extractReportName(target) {
            if (!target) return 'Unknown';
            const parts = target.replace(/\\/g, '/').split('/');
            const lastPart = parts[parts.length - 1] || parts[parts.length - 2];
            return lastPart.replace(/^https?:\/\/(www\.)?/, '').replace(/github\.com\//, '').replace(/\.git$/, '').trim() || 'Unknown';
        }

        async function loadReportHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #A0A0A0;"><div class="spinner" style="margin: 0 auto 12px;"></div><p>Loading report history...</p></div>';
            
            try {
                const response = await fetch('/api/reports');
                const data = await response.json();
                const reports = data.reports || [];
                const backups = data.backups || [];
                
                if (reports.length === 0 && backups.length === 0) { historyList.innerHTML = '<div class="no-report"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 64px; height: 64px; margin-bottom: 20px; opacity: 0.2;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg><h3>No Reports Yet</h3><p>Run your first analysis to see reports here</p></div>'; return; }
                
                const reportsWithMetadata = await Promise.all(reports.map(async (report, index) => {
                    try {
                        const metaResponse = await fetch(`/outputs/${report.filename}`);
                        const data = await metaResponse.json();
                        const metadata = data.metadata || {};
                        const securityFindings = data.security_findings || {};
                        const packages = securityFindings.packages || [];
                        let totalFindings = 0;
                        packages.forEach(pkg => { totalFindings += (pkg.findings || []).length; });
                        return { ...report, index: reports.length - index, reportName: extractReportName(metadata.target), analysisType: metadata.analysis_type || 'unknown', target: metadata.target || 'N/A', totalFindings: totalFindings, totalPackages: metadata.total_packages || packages.length || 0, isBackup: false };
                    } catch (e) { return { ...report, index: reports.length - index, reportName: 'Unknown', analysisType: 'unknown', target: 'N/A', totalFindings: 0, totalPackages: 0, isBackup: false }; }
                }));
                
                const backupsWithMetadata = await Promise.all(backups.map(async (backup, index) => {
                    try {
                        const metaResponse = await fetch(`/outputs/${backup.filename}`);
                        const data = await metaResponse.json();
                        const metadata = data.metadata || {};
                        const securityFindings = data.security_findings || {};
                        const packages = securityFindings.packages || [];
                        let totalFindings = 0;
                        packages.forEach(pkg => { totalFindings += (pkg.findings || []).length; });
                        return { ...backup, index: backups.length - index, reportName: extractReportName(metadata.target), analysisType: metadata.analysis_type || 'backup', target: metadata.target || 'N/A', totalFindings: totalFindings, totalPackages: metadata.total_packages || packages.length || 0, isBackup: true };
                    } catch (e) { return { ...backup, index: backups.length - index, reportName: 'Backup', analysisType: 'backup', target: 'N/A', totalFindings: 0, totalPackages: 0, isBackup: true }; }
                }));
                
                allReports = [...reportsWithMetadata, ...backupsWithMetadata];
                renderHistoryTable();
            } catch (error) { console.error('Error loading report history:', error); historyList.innerHTML = `<div class="no-report"><h3>Error Loading History</h3><p>${escapeHtml(error.message)}</p></div>`; }
        }

        function renderHistoryTable(filteredReports = null) {
            const historyList = document.getElementById('history-list');
            const reports = filteredReports || allReports;
            if (reports.length === 0) { historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #A0A0A0;"><p>No reports match your search.</p></div>'; return; }
            
            let html = '<div class="history-table-container"><table class="history-table"><thead><tr><th onclick="sortHistoryTable(\'index\')" style="cursor: pointer;">#</th><th onclick="sortHistoryTable(\'reportName\')" style="cursor: pointer;">Report Name</th><th onclick="sortHistoryTable(\'analysisType\')" style="cursor: pointer;">Type</th><th onclick="sortHistoryTable(\'date\')" style="cursor: pointer;">Date</th><th onclick="sortHistoryTable(\'totalFindings\')" style="cursor: pointer;">Findings</th><th onclick="sortHistoryTable(\'totalPackages\')" style="cursor: pointer;">Packages</th><th onclick="sortHistoryTable(\'size\')" style="cursor: pointer;">Size</th><th>Actions</th></tr></thead><tbody>';
            
            reports.forEach(report => {
                const date = new Date(report.modified);
                const dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const sizeKB = (report.size / 1024).toFixed(1);
                const typeLabel = report.isBackup ? 'backup' : report.analysisType.replace('_', ' ');
                const rowStyle = report.isBackup ? 'background: #FFF9E6;' : '';
                html += `<tr onclick="loadHistoricalReport('${report.filename}')" style="cursor: pointer; ${rowStyle}"><td><strong>${report.isBackup ? '📦' : '#'}${report.index}</strong></td><td><strong>${escapeHtml(report.reportName)}</strong>${report.isBackup ? ' <span style="font-size: 10px; color: #F57C00;">(BACKUP)</span>' : ''}</td><td><span class="type-badge ${report.isBackup ? 'backup' : report.analysisType}">${typeLabel}</span></td><td>${dateStr}</td><td><span class="findings-badge">${report.totalFindings}</span></td><td>${report.totalPackages}</td><td>${sizeKB} KB</td><td onclick="event.stopPropagation();"><button class="table-btn-view" onclick="loadHistoricalReport('${report.filename}')">View</button><button class="table-btn-download" onclick="downloadReport('${report.filename}')">Download</button>${report.isBackup ? `<button class="table-btn-download" onclick="restoreBackup('${report.filename}')" style="background: #4ADE80; color: #FFFFFF; border-color: #4ADE80;">Restore</button>` : ''}</td></tr>`;
            });
            
            html += `</tbody></table></div><div style="margin-top: 16px; padding: 12px; background: #FAFAFA; border: 1px solid #E5E5E5; font-size: 13px; color: #666666;">Showing ${reports.length} of ${allReports.length} reports</div>`;
            historyList.innerHTML = html;
        }

        function sortHistoryTable(column) {
            if (currentSortColumn === column) currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            else { currentSortColumn = column; currentSortDirection = 'desc'; }
            allReports.sort((a, b) => {
                let aVal, bVal;
                switch(column) {
                    case 'date': aVal = new Date(a.modified).getTime(); bVal = new Date(b.modified).getTime(); break;
                    case 'size': aVal = a.size; bVal = b.size; break;
                    case 'reportName': aVal = a.reportName.toLowerCase(); bVal = b.reportName.toLowerCase(); break;
                    case 'analysisType': aVal = a.analysisType; bVal = b.analysisType; break;
                    case 'totalFindings': aVal = a.totalFindings; bVal = b.totalFindings; break;
                    case 'totalPackages': aVal = a.totalPackages; bVal = b.totalPackages; break;
                    case 'index': aVal = a.index; bVal = b.index; break;
                    default: return 0;
                }
                if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            renderHistoryTable();
        }

        function filterHistoryTable() {
            const searchInput = document.getElementById('history-search');
            const searchTerm = searchInput.value.toLowerCase();
            if (!searchTerm) { renderHistoryTable(); return; }
            const filtered = allReports.filter(report => report.reportName.toLowerCase().includes(searchTerm) || report.analysisType.toLowerCase().includes(searchTerm) || report.target.toLowerCase().includes(searchTerm) || new Date(report.modified).toLocaleDateString().includes(searchTerm));
            renderHistoryTable(filtered);
        }

        async function loadHistoricalReport(filename) {
            try {
                const response = await fetch(`/outputs/${filename}`);
                const data = await response.json();
                currentReportData = data; currentFilter = null;
                showReportTab();
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                const reportTab = document.getElementById('report-tab');
                const reportContent = document.getElementById('report');
                if (reportTab) reportTab.classList.add('active');
                if (reportContent) reportContent.classList.add('active');
                renderReport(data);
            } catch (error) { alert('Error loading report: ' + error.message); }
        }

        function downloadReport(filename) { window.open(`/outputs/${filename}`, '_blank'); }

        async function restoreBackup(backupFilename) {
            if (!confirm(`Are you sure you want to restore this backup?\n\nThis will replace the current report with:\n${backupFilename}\n\nThe current report will be backed up first.`)) return;
            try {
                const response = await fetch('/api/restore-backup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ backup_filename: backupFilename }) });
                if (response.ok) { showToast('Backup restored successfully! Switching to report view...', 'success'); setTimeout(() => { loadReportHistory(); loadReport(); switchTab('report'); }, 1000); }
                else { const error = await response.json(); showToast('Error restoring backup: ' + error.error, 'error'); }
            } catch (error) { showToast('Error restoring backup: ' + error.message, 'error'); }
        }

        async function exportToPDF() {
            if (!currentReportData) { alert('No report data available to export'); return; }
            const exportBtn = event.target;
            const originalText = exportBtn.textContent;
            exportBtn.textContent = 'Generating PDF...'; exportBtn.disabled = true;
            try {
                const response = await fetch('/api/export-pdf', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(currentReportData) });
                if (response.ok) {
                    const result = await response.json();
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #1A1A1A; color: #FFFFFF; padding: 16px 24px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; font-size: 14px;';
                    successMsg.innerHTML = `<strong>PDF Generated Successfully!</strong><br><a href="${result.path}" download style="color: #FFFFFF; text-decoration: underline; margin-top: 8px; display: inline-block;">Download ${result.filename}</a>`;
                    document.body.appendChild(successMsg);
                    setTimeout(() => { successMsg.remove(); }, 5000);
                    window.open(result.path, '_blank');
                } else { const error = await response.json(); alert('Error generating PDF: ' + error.error); }
            } catch (error) { alert('Error generating PDF: ' + error.message); }
            finally { exportBtn.textContent = originalText; exportBtn.disabled = false; }
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const icon = document.getElementById(sectionId + '-icon');
            if (content && icon) {
                if (content.style.display === 'none') { content.style.display = 'block'; icon.style.transform = 'rotate(180deg)'; }
                else { content.style.display = 'none'; icon.style.transform = 'rotate(0deg)'; }
            }
        }

        function togglePackageCard(cardId) { const card = document.getElementById(cardId); if (card) card.classList.toggle('collapsed'); }
        function expandAllPackages() { document.querySelectorAll('.finding-card').forEach(card => { card.classList.remove('collapsed'); }); }
        function collapseAllPackages() { document.querySelectorAll('.finding-card').forEach(card => { card.classList.add('collapsed'); }); }

        function makeCVEClickable(cveId) {
            let url = '';
            if (cveId.startsWith('GHSA-')) url = `https://github.com/advisories/${cveId}`;
            else if (cveId.startsWith('CVE-')) url = `https://nvd.nist.gov/vuln/detail/${cveId}`;
            else if (cveId.startsWith('MAL-')) url = `https://osv.dev/vulnerability/${cveId}`;
            else if (cveId.startsWith('PYSEC-')) url = `https://osv.dev/vulnerability/${cveId}`;
            else return cveId;
            return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #1A1A1A; text-decoration: underline; font-weight: 600;">${cveId}</a>`;
        }

        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        function formatRecommendation(text) {
            // First escape HTML, then apply formatting
            let formatted = escapeHtml(text);
            // Convert **bold** to <strong>
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #1A1A1A; font-weight: 700;">$1</strong>');
            // Convert `code` to styled code
            formatted = formatted.replace(/`([^`]+)`/g, '<code style="background: #F3F4F6; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px; color: #DC2626;">$1</code>');
            // Convert CVE/GHSA IDs to links
            formatted = formatted.replace(/(CVE-\d{4}-\d{4,})/gi, '<a href="https://nvd.nist.gov/vuln/detail/$1" target="_blank" style="color: #DC2626; font-weight: 600;">$1</a>');
            formatted = formatted.replace(/(GHSA-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4})/gi, '<a href="https://github.com/advisories/$1" target="_blank" style="color: #DC2626; font-weight: 600;">$1</a>');
            return formatted;
        }

        function linkifyVulnerabilityIds(text) {
            const escaped = escapeHtml(text);
            return escaped
                .replace(/(GHSA-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4})/gi, (match) => `<a href="https://github.com/advisories/${match}" target="_blank" rel="noopener noreferrer" style="color: #1A1A1A; text-decoration: underline; font-weight: 600;">${match}</a>`)
                .replace(/(CVE-\d{4}-\d{4,})/gi, (match) => `<a href="https://nvd.nist.gov/vuln/detail/${match}" target="_blank" rel="noopener noreferrer" style="color: #1A1A1A; text-decoration: underline; font-weight: 600;">${match}</a>`)
                .replace(/(PYSEC-\d{4}-\d+)/gi, (match) => `<a href="https://osv.dev/vulnerability/${match}" target="_blank" rel="noopener noreferrer" style="color: #1A1A1A; text-decoration: underline; font-weight: 600;">${match}</a>`)
                .replace(/(MAL-\d{4}-\d+)/gi, (match) => `<a href="https://osv.dev/vulnerability/${match}" target="_blank" rel="noopener noreferrer" style="color: #1A1A1A; text-decoration: underline; font-weight: 600;">${match}</a>`);
        }

        document.addEventListener('DOMContentLoaded', () => { console.log('Spyder - AI-Powered Supply Chain Security Scanner initialized'); loadDashboard(); });
    </script>
    
    <!-- Spider Web Animation System -->
    <script src="/static/spider-web-animation.js"></script>
</body>
</html>
