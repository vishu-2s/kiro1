"""
Integration test for Vulnerability Analysis Agent with the orchestrator.

Tests that the agent integrates correctly with the AgentOrchestrator.
"""

import pytest
from unittest.mock import Mock, patch
from agents.vulnerability_agent import VulnerabilityAnalysisAgent
from agents.orchestrator import AgentOrchestrator
from agents.types import SharedContext, Finding
from tools.api_integration import APIResponse


class TestVulnerabilityAgentIntegration:
    """Integration tests for VulnerabilityAnalysisAgent with orchestrator."""
    
    @pytest.fixture
    def orchestrator(self):
        """Create an AgentOrchestrator instance."""
        return AgentOrchestrator()
    
    @pytest.fixture
    def vulnerability_agent(self):
        """Create a VulnerabilityAnalysisAgent instance."""
        agent = VulnerabilityAnalysisAgent()
        # Clear cache before each test
        agent.cache_manager.clear_all()
        return agent
    
    @pytest.fixture
    def mock_findings(self):
        """Create mock findings for testing."""
        return [
            Finding(
                package_name="express",
                package_version="4.17.0",
                finding_type="vulnerability",
                severity="high",
                description="Known vulnerability in express",
                detection_method="rule_based"
            ),
            Finding(
                package_name="lodash",
                package_version="4.17.15",
                finding_type="vulnerability",
                severity="medium",
                description="Known vulnerability in lodash",
                detection_method="rule_based"
            )
        ]
    
    def test_agent_registration(self, orchestrator, vulnerability_agent):
        """Test that agent can be registered with orchestrator."""
        orchestrator.register_agent("vulnerability_analysis", vulnerability_agent)
        
        assert "vulnerability_analysis" in orchestrator.agents
        assert orchestrator.agents["vulnerability_analysis"] == vulnerability_agent
    
    @patch('agents.vulnerability_agent.OSVAPIClient')
    def test_agent_execution_in_orchestrator(
        self, 
        mock_osv_client_class, 
        orchestrator, 
        vulnerability_agent,
        mock_findings
    ):
        """Test that agent executes correctly within orchestrator."""
        # Mock OSV API responses
        mock_response = Mock(spec=APIResponse)
        mock_response.is_success.return_value = True
        mock_response.get_data.return_value = {
            "vulns": [
                {
                    "id": "GHSA-test-1234",
                    "summary": "Test vulnerability in express",
                    "severity": [{"type": "CVSS_V3", "score": 7.5}],
                    "affected": [
                        {
                            "ranges": [
                                {
                                    "events": [
                                        {"introduced": "4.0.0"},
                                        {"fixed": "4.18.0"}
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        }
        
        vulnerability_agent.osv_client.query_vulnerabilities = Mock(return_value=mock_response)
        
        # Register agent
        orchestrator.register_agent("vulnerability_analysis", vulnerability_agent)
        
        # Create context
        context = SharedContext(
            initial_findings=mock_findings,
            dependency_graph={"packages": []},
            packages=["express", "lodash"],
            ecosystem="npm"
        )
        
        # Run agent stage
        result = orchestrator._run_agent_stage("vulnerability_analysis", context)
        
        # Verify result
        assert result.success == True
        assert result.agent_name == "vulnerability_analysis"
        assert "packages" in result.data
        assert len(result.data["packages"]) == 2
    
    @patch('agents.vulnerability_agent.OSVAPIClient')
    def test_agent_with_cache(
        self,
        mock_osv_client_class,
        vulnerability_agent,
        mock_findings
    ):
        """Test that agent uses caching correctly."""
        # Mock OSV API response
        mock_response = Mock(spec=APIResponse)
        mock_response.is_success.return_value = True
        mock_response.get_data.return_value = {"vulns": []}
        
        vulnerability_agent.osv_client.query_vulnerabilities = Mock(return_value=mock_response)
        
        # Create context
        context = SharedContext(
            initial_findings=mock_findings,
            dependency_graph={"packages": []},
            packages=["express"],
            ecosystem="npm"
        )
        
        # First call - should query API
        result1 = vulnerability_agent.analyze(context)
        assert vulnerability_agent.osv_client.query_vulnerabilities.call_count == 1
        
        # Second call - should use cache
        result2 = vulnerability_agent.analyze(context)
        # Note: call count might still be 1 if cache is working
        assert result2 is not None
    
    def test_agent_handles_timeout(self, vulnerability_agent, mock_findings):
        """Test that agent respects timeout."""
        # Create context with many packages
        large_package_list = [f"package-{i}" for i in range(100)]
        
        context = SharedContext(
            initial_findings=mock_findings,
            dependency_graph={"packages": []},
            packages=large_package_list,
            ecosystem="npm"
        )
        
        # Analyze with very short timeout
        result = vulnerability_agent.analyze(context, timeout=1)
        
        # Should return partial results
        assert "packages" in result
        assert result["total_packages_analyzed"] < len(large_package_list)
    
    @patch('agents.vulnerability_agent.OSVAPIClient')
    def test_agent_handles_api_failure(
        self,
        mock_osv_client_class,
        vulnerability_agent,
        mock_findings
    ):
        """Test that agent handles API failures gracefully."""
        # Mock API failure
        mock_response = Mock(spec=APIResponse)
        mock_response.is_success.return_value = False
        mock_response.error = Mock()
        mock_response.error.message = "API Error"
        
        vulnerability_agent.osv_client.query_vulnerabilities = Mock(return_value=mock_response)
        
        # Create context
        context = SharedContext(
            initial_findings=mock_findings,
            dependency_graph={"packages": []},
            packages=["express"],
            ecosystem="npm"
        )
        
        # Analyze - should not crash
        result = vulnerability_agent.analyze(context)
        
        # Should return result with no vulnerabilities
        assert "packages" in result
        assert len(result["packages"]) == 1
        assert len(result["packages"][0]["vulnerabilities"]) == 0
    
    @patch('agents.vulnerability_agent.OSVAPIClient')
    def test_confidence_scoring(
        self,
        mock_osv_client_class,
        vulnerability_agent,
        mock_findings
    ):
        """Test that agent provides confidence scores."""
        # Mock OSV API response with detailed vulnerability
        mock_response = Mock(spec=APIResponse)
        mock_response.is_success.return_value = True
        mock_response.get_data.return_value = {
            "vulns": [
                {
                    "id": "GHSA-test-1234",
                    "summary": "Test vulnerability",
                    "details": "Detailed description",
                    "severity": [{"type": "CVSS_V3", "score": 7.5}],
                    "affected": [
                        {
                            "ranges": [
                                {
                                    "events": [
                                        {"introduced": "4.0.0"},
                                        {"fixed": "4.18.0"}
                                    ]
                                }
                            ]
                        }
                    ],
                    "references": [
                        {"url": "https://example.com/advisory"}
                    ],
                    "aliases": ["CVE-2021-1234"]
                }
            ]
        }
        
        vulnerability_agent.osv_client.query_vulnerabilities = Mock(return_value=mock_response)
        
        # Create context
        context = SharedContext(
            initial_findings=mock_findings,
            dependency_graph={"packages": []},
            packages=["express"],
            ecosystem="npm"
        )
        
        # Analyze
        result = vulnerability_agent.analyze(context)
        
        # Verify confidence scoring
        assert "confidence" in result
        assert 0.0 <= result["confidence"] <= 1.0
        
        # Verify package-level confidence
        assert "confidence" in result["packages"][0]
        assert 0.0 <= result["packages"][0]["confidence"] <= 1.0
        
        # Verify reasoning is provided
        assert "reasoning" in result["packages"][0]
        assert len(result["packages"][0]["reasoning"]) > 0


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
